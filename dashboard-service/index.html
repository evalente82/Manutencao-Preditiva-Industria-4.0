<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Manutenção Preditiva - Simulação em Tempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .pulse { animation: pulse-animation 2s infinite; }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const API_BASE_URL = "http://127.0.0.1:8001";

        // =================================================================
        // 1. COMPONENTES DE VISUALIZAÇÃO (completos e definidos)
        // =================================================================

        function Header() {
            return (
                <header className="mb-6">
                    <h1 className="text-4xl font-black text-white">Dashboard de Manutenção Preditiva</h1>
                    <p className="text-gray-400">Simulação em Tempo Real</p>
                </header>
            );
        }

        function UnitSelector({ unitNumbers, selectedUnit, onUnitChange }) {
            return (
                <div className="mb-4">
                    <label htmlFor="unit-select" className="block mb-2 text-sm font-medium text-gray-300">Selecione a Unidade do Motor:</label>
                    <select id="unit-select" value={selectedUnit} onChange={e => onUnitChange(e.target.value)}
                        className="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                    {unitNumbers.map(unit => <option key={unit} value={unit}>{`Motor #${unit}`}</option>)}
                    </select>
                </div>
            );
        }

        function ChartComponent({ data, title, yLabel, dataKey, color }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            useEffect(() => {
                if (chartRef.current) {
                    const ctx = chartRef.current.getContext('2d');
                    if (chartInstance.current) {
                        chartInstance.current.data.labels = data.map(d => d.time_in_cycles);
                        chartInstance.current.data.datasets[0].data = data.map(d => d[dataKey]);
                        chartInstance.current.update('none');
                    } else {
                         chartInstance.current = new Chart(ctx, {
                            type: 'line',
                            data: { 
                                labels: data.map(d => d.time_in_cycles), 
                                datasets: [{ 
                                    label: yLabel, 
                                    data: data.map(d => d[dataKey]), 
                                    borderColor: color, 
                                    backgroundColor: color + '33', 
                                    borderWidth: 2, 
                                    pointRadius: 1, 
                                    tension: 0.1 
                                }] 
                            },
                            options: { 
                                responsive: true, 
                                maintainAspectRatio: false, 
                                animation: { duration: 0 }, 
                                plugins: { 
                                    legend: { labels: { color: '#AAA' }}, 
                                    title: { display: true, text: title, color: '#FFF' } 
                                }, 
                                scales: { 
                                    x: { title: { display: true, text: 'Tempo (em ciclos)', color: '#AAA' }, ticks: { color: '#AAA'} }, 
                                    y: { title: { display: true, text: yLabel, color: '#AAA' }, ticks: { color: '#AAA'} } 
                                } 
                            }
                        });
                    }
                }
            }, [data, title, yLabel, dataKey, color]);
            return <div className="bg-gray-800 p-4 rounded-lg shadow-lg"><div className="chart-container"><canvas ref={chartRef}></canvas></div></div>;
        }

        function LogPanel({ logs }) {
            const logContainerRef = useRef(null);
            useEffect(() => { 
                if(logContainerRef.current) { 
                    logContainerRef.current.scrollTop = 0; // Rola para o topo para ver a última mensagem
                } 
            }, [logs]);
            return (
                <div className="bg-gray-800 p-4 rounded-lg shadow-lg h-full flex flex-col">
                    <h3 className="text-lg font-bold mb-2 text-white">Log da Simulação</h3>
                    {/* A MUDANÇA ESTÁ NA LINHA ABAIXO */}
                    <div ref={logContainerRef} className="flex-grow bg-black p-2 rounded overflow-y-auto font-mono text-xs text-green-400 h-64 lg:h-96">
                        {logs.map((log, i) => <div key={i}>{`> ${log}`}</div>)}
                    </div>
                </div>
            );
        }
        
        function ConnectionStatus({ status }) {
            let color = 'bg-yellow-500'; // Ocioso / Conectando
            if (status === 'Conectado') color = 'bg-green-500 pulse';
            if (status === 'Desconectado' || status === 'Erro') color = 'bg-red-500';
            return ( 
                <div className="flex items-center gap-2 mt-4">
                    <div className={`w-3 h-3 rounded-full ${color}`}></div>
                    <span className="text-sm text-gray-300">{status}</span>
                </div> 
            );
        }

        // =================================================================
        // 2. COMPONENTE PRINCIPAL (App) com toda a lógica
        // =================================================================
        function App() {
            const [allEngineData, setAllEngineData] = useState([]);
            const [selectedUnit, setSelectedUnit] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState('Ocioso');
            const [logs, setLogs] = useState(["Aguardando início da simulação..."]);
            const [isSimulating, setIsSimulating] = useState(false);
            
            const controlWs = useRef(null);
            const dataWs = useRef(null);
            const logsWs = useRef(null);

            useEffect(() => {
                fetch(`${API_BASE_URL}/api/data/initial`)
                    .then(res => res.json())
                    .then(data => {
                        setAllEngineData(data);
                        if (data && data.length > 0) {
                            const initialUnit = [...new Set(data.map(d => d.unit_number))][0];
                            setSelectedUnit(initialUnit);
                        }
                    }).catch(err => {
                        console.error("Erro ao carregar dados iniciais:", err);
                        setLogs(prev => ["Falha ao carregar dados de exemplo. Verifique o backend.", ...prev]);
                    });

                logsWs.current = new WebSocket(`${API_BASE_URL.replace('http', 'ws')}/ws/sim_logs`);
                logsWs.current.onmessage = (event) => setLogs(prev => [event.data, ...prev].slice(0, 100));
                
                controlWs.current = new WebSocket(`${API_BASE_URL.replace('http', 'ws')}/ws/sim_control`);

                return () => {
                    if (logsWs.current) logsWs.current.close();
                    if (controlWs.current) controlWs.current.close();
                    if (dataWs.current) dataWs.current.close();
                };
            }, []);

            const handleStartStop = () => {
                const nextState = !isSimulating;
                setIsSimulating(nextState);
                if (controlWs.current && controlWs.current.readyState === WebSocket.OPEN) {
                    controlWs.current.send(nextState ? "START" : "STOP");
                }

                if (nextState) {
                    setConnectionStatus('Conectando...');
                    dataWs.current = new WebSocket(`${API_BASE_URL.replace('http', 'ws')}/ws/data`);
                    dataWs.current.onopen = () => setConnectionStatus('Conectado');
                    dataWs.current.onmessage = (event) => setAllEngineData(JSON.parse(event.data));
                    dataWs.current.onclose = () => setConnectionStatus('Desconectado');
                } else {
                    if (dataWs.current) dataWs.current.close();
                    setConnectionStatus('Ocioso');
                }
            };

            const unitNumbers = useMemo(() => [...new Set(allEngineData.map(d => d.unit_number))].sort((a, b) => a - b), [allEngineData]);
            const filteredData = useMemo(() => allEngineData.filter(d => d.unit_number == selectedUnit), [allEngineData, selectedUnit]);
            
            const KEY_SENSORS = ['sensor_2', 'sensor_3', 'sensor_4', 'sensor_7', 'sensor_11', 'sensor_12'];
            const CHART_COLORS = ['#34D399', '#FBBF24', '#F87171', '#60A5FA', '#A78BFA', '#F472B6'];

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <Header />
                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div className="lg:col-span-1 flex flex-col gap-6">
                            <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                <h3 className="text-lg font-bold mb-4 text-white">Controle</h3>
                                <button onClick={handleStartStop} className={`w-full text-white font-bold py-2 px-4 rounded ${isSimulating ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700'}`}>
                                    {isSimulating ? 'PARAR SIMULAÇÃO' : 'INICIAR SIMULAÇÃO'}
                                </button>
                                <ConnectionStatus status={connectionStatus} />
                            </div>
                            <LogPanel logs={logs} />
                        </div>
                        <div className="lg:col-span-3 flex flex-col gap-6">
                            {(unitNumbers.length > 0 && selectedUnit !== null) ? (
                                <UnitSelector unitNumbers={unitNumbers} selectedUnit={selectedUnit} onUnitChange={setSelectedUnit} />
                            ) : (
                                <div className="text-center p-8 text-gray-400 bg-gray-800 rounded-lg">
                                    {isSimulating ? 'Aguardando dados da simulação...' : 'Clique em "Iniciar Simulação" para ver os dados em tempo real.'}
                                </div>
                            )}
                            
                            {filteredData.length > 0 && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="md:col-span-2">
                                        <ChartComponent data={filteredData} title="Vida Útil Remanescente (RUL)" yLabel="RUL" dataKey="rul" color="#A855F7" />
                                    </div>
                                    {KEY_SENSORS.map((sensor, i) => (
                                        <ChartComponent key={sensor} data={filteredData} title={`Histórico - ${sensor}`} yLabel={sensor} dataKey={sensor} color={CHART_COLORS[i]} />
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // =================================================================
        // 3. INICIALIZAÇÃO DO REACT 18 (API CORRETA)
        // =================================================================
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>